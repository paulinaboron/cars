<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cars</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div>
        <a href="index.html">index</a>
        <a href="admin.html">admin</a>
        <a href="search.html">Search</a>

        <table id="tb"></table>
    </div>

    <div id="update">
        <input type="text" name="model" id="model">

        <select name="rok" id="rok">
            <option value="2001">2001</option>
            <option value="2002">2002</option>
            <option value="2003">2003</option>
            <option value="2004">2004</option>
        </select>

        <div>
            <button id="updateBtn">update</button>
            <button id="cancelBtn">cancel</button>
        </div>

    </div>

<script>
    let rowToUpdate = 0

    load = async()=>{
        let dane = await fetchPostAsync()
        console.log(dane)

        document.getElementById("tb").innerHTML = ""
        dane.forEach(row =>{
            let tr = document.createElement("tr")

            document.getElementById("tb").appendChild(tr)
            console.log(row)

            let lp = document.createElement("td")
            lp.innerText = row.id
            tr.appendChild(lp)

            let uuid = document.createElement("td")
            uuid.innerText = row.uuid
            tr.appendChild(uuid)

            let model = document.createElement("td")
            model.innerText = row.model
            tr.appendChild(model)

            let year = document.createElement("td")
            year.innerText = row.year
            tr.appendChild(year)

            let airbags = document.createElement("td")
            row.airbags.forEach(e =>
                airbags.innerHTML += `${e.desc}: ${e.value}<br>`
            )
            tr.appendChild(airbags)

            let color = document.createElement("td")
            color.style.backgroundColor = row.color
            tr.appendChild(color)

            let dlt = document.createElement("td")
            tr.appendChild(dlt)

            let dltButton = document.createElement("button")
            dltButton.innerText = "Delete Car"
            dlt.appendChild(dltButton)

            dltButton.onclick = async()=>{
                let d = await deleteCar(row.id)
                load()
            }

            let upd = document.createElement("td")
            tr.appendChild(upd)

            let updButton = document.createElement("button")
            updButton.innerText = "Update Car"
            upd.appendChild(updButton)

            updButton.onclick = function(){
                document.getElementById("update").style.visibility = "visible"
                rowToUpdate = row.id
            }
        })

    }

    fetchPostAsync = async () => {

        const options = {
            method: "GET",
        };

        let response = await fetch("/json", options)

        if (!response.ok)
            return response.status
        else
            return await response.json() // response.json
    }

    deleteCar = async (id) =>{
        const options = {
            method: "POST",
            body: JSON.stringify({id: id})
        };

        let response = await fetch("/delete", options)

        if (!response.ok)
            return response.status
        else
            return await response.json() // response.json

    }

    document.getElementById("cancelBtn").onclick = function(){
        document.getElementById("update").style.visibility = "hidden";
    }

    document.getElementById("updateBtn").onclick = async()=>{
        let d = await updateCar(rowToUpdate)
        document.getElementById("update").style.visibility = "hidden";
        load()
    }

    updateCar = async (id) =>{

        const data = JSON.stringify({
                model: document.getElementById("model").value,
                year: document.getElementById("rok").value,
                id: id
        })

        const options = {
            method: "POST",
            body: data
        };

        let response = await fetch("/update", options)

        if (!response.ok)
            return response.status
        else
            return await response.json() // response.json

    }



    load()

</script>
</body>
</html>